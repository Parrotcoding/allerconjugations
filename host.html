<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>French Aller â€“ Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #0f172a;
  color: white;
}
.screen { display: none; padding: 40px; min-height: 100vh; }
.screen.active { display: block; }
h1 { font-size: 48px; }
h2 { font-size: 28px; }
button {
  background: #6366f1;
  border: none;
  color: white;
  padding: 14px 28px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  margin: 8px;
}
button:disabled {
  background: #334155;
  cursor: not-allowed;
}
.secondary { background: #334155; }
.big-code {
  font-size: 96px;
  letter-spacing: 12px;
  font-weight: 800;
}
.card {
  background: #1e293b;
  padding: 24px;
  border-radius: 16px;
  margin: 20px 0;
}
.players {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}
.player {
  background: #334155;
  padding: 14px;
  border-radius: 12px;
  text-align: center;
}
.list { font-size: 22px; line-height: 1.6; }
</style>
</head>

<body>

<!-- CREATE -->
<div id="create" class="screen active">
  <h1>French Aller</h1>
  <button onclick="createGame('live')">Live Game</button>
  <button class="secondary" onclick="createGame('self')">Self-Paced</button>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
  <h1>Join at</h1>
  <div class="big-code" id="code"></div>

  <div class="card">
    <h2>Players</h2>
    <div id="players" class="players"></div>
  </div>

  <button id="startBtn" onclick="startInstructions()" disabled>
    Start Game
  </button>
</div>

<!-- INSTRUCTIONS -->
<div id="instructions" class="screen">
  <h1>LOOK UP ðŸ‘€</h1>
  <div class="card">
    <p class="list">
      â€¢ Build the French sentence using <b>aller</b><br>
      â€¢ Live mode: one speaker sees English<br>
      â€¢ Self-paced: answer at your own speed<br>
      â€¢ Faster answers = more points
    </p>
  </div>

  <button id="beginBtn" onclick="startRound()" disabled>
    Begin
  </button>
</div>

<!-- QUESTION -->
<div id="question" class="screen">
  <h1 id="questionTitle">Question Live</h1>

  <div class="card">
    <h2>Answered</h2>
    <div id="answeredList" class="list">Waitingâ€¦</div>
  </div>

  <button id="nextBtn" onclick="nextStep()" disabled>
    Next
  </button>
</div>

<!-- LEADERBOARD -->
<div id="leaderboard" class="screen">
  <h1>Leaderboard</h1>
  <div id="leaderboardList" class="list"></div>

  <button onclick="startRound()">Next Question</button>
  <button class="secondary" onclick="endGame()">End Game</button>
</div>

<!-- END -->
<div id="end" class="screen">
  <h1>Game Finished</h1>
  <button onclick="closeServer()">Close Server</button>
</div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://nbkdmwqwujjrflsgvbge.supabase.co";
const SUPABASE_KEY = "sb_publishable_ImkyFfHOON2jse0RTduhww_eHGaTJTh";

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY, {
  global: {
    headers: () => ({
      "host-secret": localStorage.getItem("hostSecret")
    })
  }
});

/* ================= STATE ================= */
let game = null;
let pollGame, pollPlayers, pollAnswers;

/* ================= HELPERS ================= */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
function genCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

/* ================= QUESTIONS ================= */
const QUESTIONS = [
  { en: "Emily is going to the library.", fr: "elle va Ã  la bibliothÃ¨que" },
  { en: "We are going to the cafeteria.", fr: "nous allons Ã  la cantine" },
  { en: "They are going on vacation.", fr: "ils vont en vacances" },
  { en: "I am going to study.", fr: "je vais Ã©tudier" }
];

/* ================= CREATE GAME ================= */
async function createGame(mode) {
  const code = genCode();
  const hostSecret = crypto.randomUUID();
  localStorage.setItem("hostSecret", hostSecret);

  const { data } = await sb.from("games")
    .insert({ code, mode, host_secret: hostSecret })
    .select().single();

  game = data;
  document.getElementById("code").textContent = code;

  startPolling();
  show("lobby");
}

/* ================= POLLING ================= */
function startPolling() {
  pollPlayers = setInterval(loadPlayers, 2000);
  pollGame = setInterval(loadGame, 1500);
}

async function loadPlayers() {
  if (!game) return;

  const { data } = await sb.from("players")
    .select("*")
    .eq("game_id", game.id);

  const el = document.getElementById("players");
  el.innerHTML = "";

  data.forEach(p => {
    const d = document.createElement("div");
    d.className = "player";
    d.textContent = p.name;
    el.appendChild(d);
  });

  const ready = data.length > 0;
  document.getElementById("startBtn").disabled = !ready;
  document.getElementById("beginBtn").disabled = !ready;
}

async function loadGame() {
  if (!game) return;

  const { data } = await sb.from("games")
    .select("*")
    .eq("id", game.id)
    .single();

  game = data;
}

/* ================= FLOW ================= */
async function startInstructions() {
  await sb.from("games")
    .update({ status: "instructions" })
    .eq("id", game.id);

  show("instructions");
}

async function startRound() {
  const { data: players } = await sb.from("players")
    .select("*")
    .eq("game_id", game.id);

  if (!players.length) return alert("No players");

  const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];

  await sb.from("players")
    .update({ answered: false })
    .eq("game_id", game.id);

  await sb.from("games").update({
    status: "question",
    question_index: game.question_index + 1,
    current_question: q,
    speaker_player_id:
      game.mode === "live"
        ? players[Math.floor(Math.random() * players.length)].id
        : null
  }).eq("id", game.id);

  game.question_index++;
  document.getElementById("questionTitle").textContent =
    game.mode === "live" ? "Question Live" : "Self-Paced Question";

  document.getElementById("answeredList").textContent =
    game.mode === "live" ? "Waitingâ€¦" : "Answeringâ€¦";

  document.getElementById("nextBtn").disabled = game.mode === "live";
  pollAnswers = setInterval(checkAnswered, 1000);

  show("question");
}

async function checkAnswered() {
  const { data } = await sb.from("players")
    .select("answered")
    .eq("game_id", game.id);

  const answered = data.filter(p => p.answered).length;

  if (game.mode === "live" && answered === data.length && data.length > 0) {
    document.getElementById("nextBtn").disabled = false;
    clearInterval(pollAnswers);
  }

  if (game.mode === "self") {
    clearInterval(pollAnswers);
    showLeaderboard();
  }
}

async function nextStep() {
  showLeaderboard();
}

async function showLeaderboard() {
  const { data } = await sb.from("players")
    .select("name,total_points")
    .eq("game_id", game.id)
    .order("total_points", { ascending: false });

  leaderboardList.innerHTML =
    data.map((p,i)=>`${i+1}. ${p.name} â€” ${p.total_points}`).join("<br>");

  await sb.from("games")
    .update({ status: "leaderboard" })
    .eq("id", game.id);

  show("leaderboard");
}

async function endGame() {
  await sb.from("games")
    .update({ status: "ended" })
    .eq("id", game.id);

  show("end");
}

async function closeServer() {
  await sb.from("games").delete().eq("id", game.id);
  location.reload();
}
</script>

</body>
</html>
