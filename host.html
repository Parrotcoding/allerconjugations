<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>French Aller â€“ Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #0f172a;
  color: white;
}
.screen { display: none; padding: 40px; min-height: 100vh; }
.screen.active { display: block; }
h1 { font-size: 48px; }
h2 { font-size: 28px; }
button {
  background: #6366f1;
  border: none;
  color: white;
  padding: 14px 28px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
  margin: 8px;
}
button:disabled {
  background: #334155;
  cursor: not-allowed;
}
.secondary { background: #334155; }
.big-code {
  font-size: 96px;
  letter-spacing: 12px;
  font-weight: 800;
}
.card {
  background: #1e293b;
  padding: 24px;
  border-radius: 16px;
  margin: 20px 0;
}
.players {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}
.player {
  background: #334155;
  padding: 14px;
  border-radius: 12px;
  text-align: center;
}
.list { font-size: 22px; line-height: 1.6; }
.podium { display: flex; gap: 20px; }
.podium div {
  flex: 1;
  background: #334155;
  padding: 24px;
  border-radius: 16px;
  text-align: center;
  font-size: 26px;
}
</style>
</head>

<body>

<!-- CREATE -->
<div id="create" class="screen active">
  <h1>French Aller</h1>
  <button onclick="createGame('live')">Live Game</button>
  <button class="secondary" onclick="createGame('self')">Self-Paced</button>
</div>

<!-- LOBBY -->
<div id="lobby" class="screen">
  <h1>Join at</h1>
  <div class="big-code" id="code"></div>

  <div class="card">
    <h2>Players</h2>
    <div id="players" class="players"></div>
  </div>

  <button id="startBtn" onclick="startInstructions()" disabled>
    Start Game
  </button>
</div>

<!-- INSTRUCTIONS -->
<div id="instructions" class="screen">
  <h1>LOOK UP ðŸ‘€</h1>
  <div class="card">
    <p class="list">
      â€¢ Build the French sentence using <b>aller</b><br>
      â€¢ Faster answers = more points<br>
      â€¢ One speaker sees English<br>
      â€¢ Others use the word bank
    </p>
  </div>
  <button id="beginBtn" onclick="startRound()" disabled>
    Begin
  </button>
</div>

<!-- QUESTION -->
<div id="question" class="screen">
  <h1>Question Live</h1>
  <div class="card">
    <h2>Answered</h2>
    <div id="answeredList" class="list">Waitingâ€¦</div>
  </div>
  <button id="nextBtn" onclick="showLeaderboard()" disabled>
    Next
  </button>
</div>

<!-- LEADERBOARD -->
<div id="leaderboard" class="screen">
  <h1>Leaderboard</h1>
  <div id="leaderboardList" class="list"></div>
  <button onclick="startRound()">Next Question</button>
  <button class="secondary" onclick="endGame()">End Game</button>
</div>

<!-- END -->
<div id="end" class="screen">
  <h1>Final Podium</h1>
  <div id="podium" class="podium"></div>
  <button onclick="closeServer()">Close Server</button>
</div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://nbkdmwqwujjrflsgvbge.supabase.co";
const SUPABASE_KEY = "sb_publishable_ImkyFfHOON2jse0RTduhww_eHGaTJTh";

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY, {
  global: {
    headers: () => ({
      "host-secret": localStorage.getItem("hostSecret")
    })
  }
});
/* ================= STATE ================= */
let game = null;

/* ================= HELPERS ================= */
function show(id) {
  document.querySelectorAll(".screen").forEach(s =>
    s.classList.remove("active")
  );
  document.getElementById(id).classList.add("active");
}
function genCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

/* ================= QUESTIONS ================= */
const QUESTIONS = [
  { en: "Emily is going to the library.", fr: "elle va Ã  la bibliothÃ¨que" },
  { en: "We are going to the cafeteria.", fr: "nous allons Ã  la cantine" },
  { en: "They are going on vacation.", fr: "ils vont en vacances" },
  { en: "I am going to study.", fr: "je vais Ã©tudier" }
];

/* ================= GAME CREATION ================= */
async function createGame(mode) {
  const code = genCode();
  const hostSecret = crypto.randomUUID();
  localStorage.setItem("hostSecret", hostSecret);

  const { data, error } = await sb
    .from("games")
    .insert({ code, mode, host_secret: hostSecret })
    .select()
    .single();

  if (error) {
    alert("Failed to create game");
    console.error(error);
    return;
  }

  game = data;
  document.getElementById("code").textContent = code;

  subscribeGame();
  subscribePlayers();

  show("lobby");
}

/* ================= REALTIME ================= */
function subscribeGame() {
  sb.channel("game-" + game.id)
    .on(
      "postgres_changes",
      { event: "*", table: "games", filter: `id=eq.${game.id}` },
      payload => {
        if (payload.new) game = payload.new;
      }
    )
    .subscribe();
}

function subscribePlayers() {
  sb.channel("players-" + game.id)
    .on(
      "postgres_changes",
      { event: "*", table: "players", filter: `game_id=eq.${game.id}` },
      loadPlayers
    )
    .subscribe();

  loadPlayers();
}

function subscribeAnswers() {
  sb.channel("answers-" + game.id)
    .on(
      "postgres_changes",
      { event: "insert", table: "answers", filter: `game_id=eq.${game.id}` },
      loadAnswered
    )
    .subscribe();
}

/* ================= LOBBY ================= */
async function loadPlayers() {
  const { data } = await sb
    .from("players")
    .select("*")
    .eq("game_id", game.id);

  const list = document.getElementById("players");
  list.innerHTML = "";

  data.forEach(p => {
    const el = document.createElement("div");
    el.className = "player";
    el.textContent = p.name;
    list.appendChild(el);
  });

  const ready = data.length > 0;
  document.getElementById("startBtn").disabled = !ready;
  document.getElementById("beginBtn").disabled = !ready;
}

/* ================= FLOW ================= */
async function startInstructions() {
  await sb.from("games")
    .update({ status: "instructions" })
    .eq("id", game.id);

  show("instructions");
}

async function startRound() {
  const { data: players } = await sb
    .from("players")
    .select("*")
    .eq("game_id", game.id);

  if (!players || players.length === 0) {
    alert("At least one player must join.");
    return;
  }

  const speaker = players[Math.floor(Math.random() * players.length)];
  const q = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];

  await sb.from("players")
    .update({ answered: false })
    .eq("game_id", game.id);

  await sb.from("games")
    .update({
      status: "question",
      question_index: game.question_index + 1,
      speaker_player_id: speaker.id,
      current_question: q
    })
    .eq("id", game.id);

  game.question_index++;
  document.getElementById("answeredList").textContent = "Waitingâ€¦";
  document.getElementById("nextBtn").disabled = true;

  subscribeAnswers();
  show("question");
}

async function loadAnswered() {
  const { data } = await sb
    .from("answers")
    .select("players(name)")
    .eq("game_id", game.id)
    .eq("question_index", game.question_index)
    .order("created_at");

  document.getElementById("answeredList").innerHTML =
    data.map((a, i) => `${i + 1}. ${a.players.name}`).join("<br>");

  const { count: answered } = await sb
    .from("players")
    .select("*", { count: "exact", head: true })
    .eq("game_id", game.id)
    .eq("answered", true);

  const { count: total } = await sb
    .from("players")
    .select("*", { count: "exact", head: true })
    .eq("game_id", game.id);

  if (answered === total) {
    document.getElementById("nextBtn").disabled = false;
  }
}

async function showLeaderboard() {
  const { data } = await sb
    .from("players")
    .select("name,total_points")
    .eq("game_id", game.id)
    .order("total_points", { ascending: false });

  document.getElementById("leaderboardList").innerHTML =
    data.map((p, i) => `${i + 1}. ${p.name} â€” ${p.total_points}`).join("<br>");

  await sb.from("games")
    .update({ status: "leaderboard" })
    .eq("id", game.id);

  show("leaderboard");
}

async function endGame() {
  await sb.from("games")
    .update({ status: "ended" })
    .eq("id", game.id);

  const { data } = await sb
    .from("players")
    .select("name,total_points")
    .eq("game_id", game.id)
    .order("total_points", { ascending: false })
    .limit(3);

  document.getElementById("podium").innerHTML =
    data.map((p, i) =>
      `<div>${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]}<br>${p.name}<br>${p.total_points}</div>`
    ).join("");

  show("end");
}

async function closeServer() {
  await sb.from("games").delete().eq("id", game.id);
  location.reload();
}
</script>

</body>
</html>
