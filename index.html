<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>French Aller â€“ Join</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system;
  background: #0f172a;
  color: white;
}
.screen { display: none; padding: 40px; min-height: 100vh; }
.screen.active { display: block; }
h1 { font-size: 42px; }
input {
  font-size: 20px;
  padding: 12px;
  width: 100%;
  margin-bottom: 12px;
  border-radius: 8px;
  border: none;
}
button {
  background: #6366f1;
  border: none;
  color: white;
  padding: 14px 28px;
  font-size: 18px;
  border-radius: 10px;
  cursor: pointer;
}
.wordbank {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 20px;
}
.word {
  background: #334155;
  padding: 12px 18px;
  border-radius: 10px;
  cursor: pointer;
}
.answer {
  min-height: 50px;
  background: #020617;
  border-radius: 10px;
  padding: 12px;
  margin-top: 16px;
}
.timer {
  font-size: 32px;
  margin-top: 10px;
}
</style>
</head>

<body>

<!-- JOIN -->
<div id="join" class="screen active">
  <h1>Join Game</h1>
  <input id="codeInput" placeholder="Game Code">
  <input id="nameInput" placeholder="Your Name">
  <button onclick="joinGame()">Join</button>
</div>

<!-- WAIT -->
<div id="lobby" class="screen">
  <h1>Waiting for hostâ€¦</h1>
</div>

<!-- LOOK UP -->
<div id="instructions" class="screen">
  <h1>LOOK UP ðŸ‘€</h1>
  <p>Instructions are on the board.</p>
</div>

<!-- QUESTION -->
<div id="question" class="screen">
  <h1 id="prompt"></h1>
  <div class="timer" id="timer">0</div>
  <div id="answer" class="answer"></div>
  <div id="wordbank" class="wordbank"></div>
  <button onclick="submitAnswer()">Submit</button>
</div>

<!-- LEADERBOARD -->
<div id="leaderboard" class="screen">
  <h1>Leaderboard</h1>
  <div id="leaderboardList"></div>
</div>

<!-- END -->
<div id="end" class="screen">
  <h1>Game Over</h1>
  <div id="finalList"></div>
</div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://nbkdmwqwujjrflsgvbge.supabase.co";
const SUPABASE_KEY = "sb_publishable_ImkyFfHOON2jse0RTduhww_eHGaTJTh";

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY, {
  global: {
    headers: () => ({
      "host-secret": localStorage.getItem("hostSecret")
    })
  }
});

/* ===== STATE ===== */
let game = null;
let player = null;
let pollGame = null;
let pollPlayers = null;
let startTime = 0;
let built = [];

/* ===== UI ===== */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ===== JOIN ===== */
async function joinGame() {
  const code = codeInput.value.toUpperCase();
  const name = nameInput.value || "Player";

  const { data: g } = await sb
    .from("games")
    .select("*")
    .eq("code", code)
    .single();

  if (!g) return alert("Game not found");

  game = g;

  const token = crypto.randomUUID();
  localStorage.setItem("joinToken", token);

  const { data: p } = await sb.from("players")
    .insert({
      game_id: game.id,
      name,
      pronoun: "je",
      join_token: token
    })
    .select()
    .single();

  player = p;

  startPolling();
  show("lobby");
}

/* ===== POLLING ===== */
function startPolling() {
  pollGame = setInterval(loadGame, 1500);
  pollPlayers = setInterval(loadPlayers, 2000);
}

async function loadGame() {
  const { data } = await sb
    .from("games")
    .select("*")
    .eq("id", game.id)
    .single();

  if (!data) return;

  game = data;

  if (game.status === "instructions") show("instructions");
  if (game.status === "question") loadQuestion();
  if (game.status === "leaderboard") loadLeaderboard();
  if (game.status === "ended") loadFinal();
}

async function loadPlayers() {
  // placeholder for leaderboard polling
}

/* ===== QUESTION ===== */
function loadQuestion() {
  built = [];
  document.getElementById("answer").textContent = "";
  document.getElementById("wordbank").innerHTML = "";
  startTime = Date.now();

  const q = game.current_question;
  const isSpeaker = game.speaker_player_id === player.id;

  document.getElementById("prompt").textContent =
    isSpeaker ? q.en : "Build the sentence";

  if (!isSpeaker) {
    q.fr.split(" ").sort(() => Math.random() - 0.5).forEach(w => {
      const el = document.createElement("div");
      el.className = "word";
      el.textContent = w;
      el.onclick = () => {
        built.push(w);
        document.getElementById("answer").textContent = built.join(" ");
        el.remove();
      };
      document.getElementById("wordbank").appendChild(el);
    });
  }

  show("question");
}

/* ===== SUBMIT ===== */
async function submitAnswer() {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const points = Math.max(1000 - elapsed * 10, 500);
  const correct = built.join(" ") === game.current_question.fr;

  await sb.from("answers").insert({
    game_id: game.id,
    player_id: player.id,
    question_index: game.question_index,
    is_correct: correct,
    points_awarded: points
  });

  await sb.from("players")
    .update({
      answered: true,
      total_points: player.total_points + points
    })
    .eq("id", player.id);

  show("lobby");
}

/* ===== LEADERBOARD ===== */
async function loadLeaderboard() {
  const { data } = await sb.from("players")
    .select("name,total_points")
    .eq("game_id", game.id)
    .order("total_points", { ascending: false });

  leaderboardList.innerHTML =
    data.map((p,i)=>`${i+1}. ${p.name} â€” ${p.total_points}`).join("<br>");

  show("leaderboard");
}

/* ===== FINAL ===== */
function loadFinal() {
  finalList.innerHTML = leaderboardList.innerHTML;
  show("end");
}
</script>

</body>
</html>
